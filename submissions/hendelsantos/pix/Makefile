.PHONY: help dev run build test test-coverage test-integration clean deps lint format setup db-create db-migrate db-reset logs

# Colors for help output
BLUE := \033[36m
NC := \033[0m # No Color

# Default target
.DEFAULT_GOAL := help

help: ## ğŸ“‹ Mostra todos os comandos disponÃ­veis
	@echo "$(BLUE)ğŸš€ Conty PIX - Sistema de Pagamentos$(NC)"
	@echo ""
	@echo "$(BLUE)Comandos disponÃ­veis:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(BLUE)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""

# ğŸš€ Development
dev: ## ğŸ³ Iniciar ambiente completo com Docker Compose
	docker-compose up --build

dev-bg: ## ğŸ³ Iniciar em background
	docker-compose up -d --build

stop: ## ğŸ›‘ Parar todos os containers
	docker-compose down

logs: ## ğŸ“‹ Acompanhar logs da aplicaÃ§Ã£o
	docker-compose logs -f app

setup: deps db-setup ## ğŸ”§ ConfiguraÃ§Ã£o inicial completa

# ğŸƒ Local Development
run: ## ğŸƒ Executar aplicaÃ§Ã£o localmente
	go run cmd/api/main.go

run-watch: ## ğŸ‘ï¸ Executar com live reload (requer air)
	air

build: ## ğŸ”¨ Compilar aplicaÃ§Ã£o
	go build -o bin/api cmd/api/main.go

build-linux: ## ğŸ§ Compilar para Linux
	GOOS=linux GOARCH=amd64 go build -o bin/api-linux cmd/api/main.go

# ğŸ§ª Testing
test: ## ğŸ§ª Executar testes unitÃ¡rios
	go test -v ./internal/...

test-coverage: ## ğŸ“Š Executar testes com coverage
	go test -v -coverprofile=coverage.out ./internal/...
	go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report: coverage.html"

test-integration: ## ğŸ”— Executar testes de integraÃ§Ã£o
	go test -v -tags=integration ./tests/...

benchmark: ## âš¡ Executar benchmarks
	go test -bench=. -benchmem ./internal/...

# ğŸ—ƒï¸ Database
db-setup: db-create db-migrate ## ğŸ—ƒï¸ ConfiguraÃ§Ã£o completa do banco

db-create: ## ğŸ“¦ Criar banco de dados
	sudo -u postgres createdb conty_pix || echo "Database already exists"

db-migrate: ## â¬†ï¸ Aplicar migraÃ§Ãµes
	sudo -u postgres psql -d conty_pix -f migrations/001_initial_schema.up.sql

db-migrate-down: ## â¬‡ï¸ Reverter migraÃ§Ãµes
	sudo -u postgres psql -d conty_pix -f migrations/001_initial_schema.down.sql

db-reset: db-migrate-down db-migrate ## ğŸ”„ Resetar banco de dados

db-shell: ## ğŸ’» Acessar shell do PostgreSQL
	sudo -u postgres psql -d conty_pix

db-status: ## ğŸ“Š Status do banco
	sudo -u postgres psql -d conty_pix -c "SELECT COUNT(*) as payouts FROM payouts; SELECT COUNT(*) as reports FROM batch_reports;"

# ğŸ”§ Utilities
deps: ## ğŸ“¦ Instalar/atualizar dependÃªncias
	go mod download
	go mod tidy

deps-update: ## ğŸ”„ Atualizar todas as dependÃªncias
	go get -u ./...
	go mod tidy

lint: ## ğŸ” Executar linter
	golangci-lint run || echo "Install golangci-lint: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(shell go env GOPATH)/bin v1.54.2"

format: ## ğŸ’… Formatar cÃ³digo
	go fmt ./...
	gofumpt -l -w . || echo "Install gofumpt: go install mvdan.cc/gofumpt@latest"

vet: ## ğŸ” Analisar cÃ³digo
	go vet ./...

mod-verify: ## âœ… Verificar integridade dos mÃ³dulos
	go mod verify

# ğŸ§¹ Cleanup
clean: ## ğŸ§¹ Limpar arquivos temporÃ¡rios
	rm -rf bin/
	rm -f coverage.out coverage.html
	go clean -cache
	docker system prune -f

clean-all: clean ## ğŸ—‘ï¸ Limpeza completa (incluindo containers e volumes)
	docker-compose down -v
	docker system prune -a -f --volumes

# ğŸš€ Production
docker-build: ## ğŸ³ Build da imagem Docker
	docker build -t conty-pix-api .

docker-run: ## ğŸƒ Executar container Docker
	docker run -p 8080:8080 --env-file .env conty-pix-api

# ğŸ” Monitoring
health: ## ğŸ’“ Verificar saÃºde da aplicaÃ§Ã£o
	curl -f http://localhost:8080/health || echo "âŒ Service not healthy"

test-api: ## ğŸ§ª Testar API completa
	@echo "ğŸ” Testing health endpoint..."
	curl -s http://localhost:8080/health | jq .
	@echo ""
	@echo "ğŸ’° Testing payout processing..."
	curl -s -X POST http://localhost:8080/payouts/batch \
		-H "Content-Type: application/json" \
		--data @seeds/payouts_batch_example.json | jq .

stress-test: ## âš¡ Teste de stress bÃ¡sico
	@echo "ğŸš€ Running stress test..."
	for i in {1..10}; do \
		curl -s -X POST http://localhost:8080/payouts/batch \
			-H "Content-Type: application/json" \
			--data @seeds/payouts_batch_example.json > /dev/null & \
	done; wait
	@echo "âœ… Stress test completed"

# ğŸ“‹ Documentation
docs: ## ğŸ“š Gerar documentaÃ§Ã£o
	godoc -http=:6060 &
	@echo "ğŸ“š Documentation available at http://localhost:6060"

tree: ## ğŸŒ³ Mostrar estrutura do projeto
	tree -I 'bin|vendor|node_modules|.git' .

install-tools: ## ğŸ› ï¸ Instalar ferramentas de desenvolvimento
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install mvdan.cc/gofumpt@latest
	go install github.com/cosmtrek/air@latest

# ğŸ“Š Statistics
stats: ## ğŸ“Š EstatÃ­sticas do projeto
	@echo "ğŸ“Š Project Statistics:"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ğŸ“ Files:"
	@find . -name "*.go" -not -path "./vendor/*" | wc -l | xargs echo "  Go files:"
	@find . -name "*.sql" | wc -l | xargs echo "  SQL files:"
	@echo "ğŸ“ Lines of code:"
	@find . -name "*.go" -not -path "./vendor/*" -exec wc -l {} + | tail -n1 | awk '{print "  Go: " $$1 " lines"}'
	@echo "ğŸ“¦ Dependencies:"
	@go list -m all | wc -l | xargs echo "  Modules:"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"