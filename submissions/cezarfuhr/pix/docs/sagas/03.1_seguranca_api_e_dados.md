### **Plano de Execução: Saga 3.1 - Segurança da API e de Dados**

**Objetivo:** Adicionar uma camada de segurança à API, exigindo uma chave de acesso estática, e garantir que dados sensíveis (PII) como a `pix_key` sejam tratados de forma segura, evitando sua exposição em logs.

---

### **Passos de Execução**

**1. Configurar a Chave de API:**
   - Crie um arquivo `.env` na raiz do projeto (se ainda não existir) e adicione a chave.
     ```
     API_KEY="CONTY_CHALLENGE_SUPER_SECRET_KEY"
     ```
   - Garanta que `.env` esteja no `.gitignore`.
   - Adicione a `API_KEY` ao modelo de configurações em `app/core/config.py`.
     ```python
     # Em app/core/config.py, dentro da classe Settings
     API_KEY: str
     ```

**2. Implementar a Dependência de Segurança:**
   - Em `app/dependencies.py`, crie a lógica que valida a chave de API enviada no header.
     ```python
     # Adicionar ao início de app/dependencies.py
     from fastapi import Security, HTTPException, status
     from fastapi.security import APIKeyHeader
     from .core.config import settings

     api_key_header = APIKeyHeader(name="X-API-Key", auto_error=False)

     def validate_api_key(key: str = Security(api_key_header)):
         if not key or key != settings.API_KEY:
             raise HTTPException(
                 status_code=status.HTTP_401_UNAUTHORIZED,
                 detail="Invalid or missing API Key"
             )
     ```

**3. Proteger o Endpoint de Lote:**
   - Em `app/api.py`, adicione a dependência de validação ao endpoint `process_payout_batch`.
     ```python
     # Em app/api.py, na assinatura da função process_payout_batch
     # Adicione a dependência: , _: bool = Depends(validate_api_key)
     # A assinatura completa fica:
     def process_payout_batch(
         batch: PayoutBatch,
         db: Session = Depends(get_db_session),
         _api_key: bool = Depends(validate_api_key)
     ):
     ```

**4. Tratar Dados Sensíveis com `SecretStr`:**
   - Em `app/models.py`, importe `SecretStr` do Pydantic e use-o para o campo `pix_key`.
     ```python
     # Em app/models.py
     from pydantic import BaseModel, Field, SecretStr

     # Na classe PayoutItem, mude a linha:
     # pix_key: str
     # Para:
     pix_key: SecretStr
     ```

**5. Atualizar Testes para Incluir Segurança:**
   - Em `tests/test_payouts_api.py`, atualize o teste E2E para enviar a chave de API correta. Adicione também testes para os casos de falha de autenticação.
     ```python
     # Em tests/test_payouts_api.py
     import os
     # Defina a chave no ambiente de teste
     os.environ['API_KEY'] = 'test-key'
     from app.core.config import settings

     def test_process_batch_no_api_key():
         response = client.post("/api/v1/payouts/batch", json={})
         assert response.status_code == 401

     def test_process_batch_wrong_api_key():
         headers = {"X-API-Key": "wrong-key"}
         response = client.post("/api/v1/payouts/batch", json={}, headers=headers)
         assert response.status_code == 401

     # Na função test_process_batch_successfully, adicione o header:
     def test_process_batch_successfully():
         headers = {"X-API-Key": settings.API_KEY}
         # ... (resto do payload)
         response = client.post("/api/v1/payouts/batch", json=payload, headers=headers)
         # ... (resto dos asserts)
     ```

---

**Critério de Sucesso:**
1.  O endpoint `/payouts/batch` deve retornar `401 Unauthorized` se a `X-API-Key` estiver ausente ou incorreta.
2.  O teste E2E (`test_process_batch_successfully`) deve ser atualizado para incluir a chave de API e continuar falhando pela mesma razão de antes (lógica de negócio).
3.  Os novos testes de segurança devem passar.
4.  Ao inspecionar os logs ou qualquer representação de um objeto `PayoutItem`, o valor de `pix_key` deve aparecer mascarado (ex: `**********`).
